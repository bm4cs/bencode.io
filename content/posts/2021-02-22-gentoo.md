---
layout: post
title: "Gentoo Linux"
draft: false
slug: "gentoo"
date: "2021-02-22 21:29:55"
lastmod: "2021-03-14 22:24:40"
comments: false
categories:
    - linux
tags:
    - gentoo
---

The next step in my minimalist computer journey.

Enter Gentoo, my first source based GNU/Linux distro. Pre-packaged binaries, which is the approach most other (binary based) distros take, must often cater for the lowest common denominator to ensure packages can run on lots of differing setups out in the wild. On a source based distro, I can articulate my specific needs (USE flags on Gentoo) to finely tune the binaries to my system. For example, as I plan to steer clear of software like systemd, kde and gnome, I can ensure support for these packages is NOT built into other program binaries I build for my system.

This is a big win for performance and security.

Read the [Gentoo AMD64 Handbook](https://wiki.gentoo.org/wiki/Handbook:AMD64).

Below are my notes after walking through the handbook.

<!-- vim-markdown-toc GFM -->

* [Preparation stage](#preparation-stage)
    * [Make LiveUSB key](#make-liveusb-key)
    * [Wifi](#wifi)
    * [Partition disk](#partition-disk)
    * [Format partitions](#format-partitions)
    * [Time](#time)
    * [Stage 3 tarball](#stage-3-tarball)
        * [Stage tarball wtf?](#stage-tarball-wtf)
    * [Emerge compile options](#emerge-compile-options)
    * [Mirrors](#mirrors)
    * [DNS](#dns)
    * [Bind mount pseudo-filesystems](#bind-mount-pseudo-filesystems)
    * [chroot](#chroot)
    * [Update the ebuild repository](#update-the-ebuild-repository)
    * [The profile](#the-profile)
    * [Update the @world set](#update-the-world-set)
    * [Timezone](#timezone)
    * [Locale](#locale)
* [Configuring a kernel](#configuring-a-kernel)
    * [menuconfig](#menuconfig)

<!-- vim-markdown-toc -->

# Preparation stage

## Make LiveUSB key

Download the latest iso, and use the [gentoo-usb.sh](https://wiki.gentoo.org/wiki/LiveUSB/Guide) script provided.

Boot the system.

## Wifi

Now in the running LiveUSB environment, setup temporarily configured wifi using `wpa_supplicant` like so:

```
wpa_supplicant -B -i $INTERFACE -c <(wpa_passphrase $SSID $PSK)
dhcpcd $INTERFACE
```

Don't waste time with `iw`, which doesnt support WPA/WPA2.

## Partition disk

I'm installing on my new system which is UEFI (not BIOS) based and has an NVME drive.

Aiming for 4 partitions:

-   `/dev/nvme0n1p1`: 2MiB for GRUB bootloader
-   `/dev/nvme0n1p2`: 128MiB for ESP (EFI) boot partition (FAT32)
-   `/dev/nvme0n1p3`: 18000MiB for swap
-   `/dev/nvme0n1p4`: Rest of the disk for `/`

Hence I'll be making a small FAT32 based ESP (EFI System Partition) partition, done with `set 2 boot on`.

I decided on 18000MiB of swap given the system has 16GB of RAM (i.e. RAM size + 2GiB).

```
parted -a optimal /dev/nmve0n1
(parted) mklabel gpt
(parted) unit mib
(parted) mkpart primary 1 3
(parted) name 1 grub
(parted) set 1 bios_grub on
(parted) mkpart primary 3 131
(parted) name 2 boot
(parted) set 2 boot on
(parted) mkpart primary 131 18131
(parted) name 3 swap
(parted) mkpart primary 18131 -1
(parted) name 4 rootfs
```

## Format partitions

Nothing fancy here, fat32 for the ESP, and ext4 for `/`.

```
mkfs.vfat /dev/nvme0n1p2
mkfs.ext4 /dev/nvme0n1p4
mkswap /dev/nvme0n1p3
swapon /dev/nvme0n1p3
mkdir -p /mnt/gentoo
mount /dev/nvme0n1p4 /mnt/gentoo
```

## Time

To keep various underlying crypto (GPG, TLS) happy, time sync your clock before proceeding.

```
ntpd -q -g
```

## Stage 3 tarball

### Stage tarball wtf?

A stage tarball is just an archive containing a minimal environment.

> A stage 3 tarball provides an almost-complete and almost-functional system (the most important parts still missing are a kernel and a bootloader).

There are a number of stages to choose from, some key upfront design decisions you'll need to make:

-   init system: openrc or systemd
-   lib bitness: multilib (32 and 64) or pure 64 (no multilib)
-   hardened for a lean

Using the `links` ncurses based terminal web browser, head to [https://gentoo.org/downloads/mirrors/]()

I used the aarnet mirror to download the latest openrc based multilib stage3 `stage3-amd64-20210310T214503Z.tar.xz` (about 200Mb), straight to `/mnt/gentoo/` which should be mounted to the targeted primary `/` partition.

Download the `stage3-amd64-20210310T214503Z.tar.xz.DIGESTS.xz` too.

Validate the checksum, the following should get a match:

```
grep $(sha512sum stage3-amd64-20210310T214503Z.tar.xz) stage3-amd64-20210310T214503Z.tar.xz.DIGESTS.xz --color
```

If checksum good, unpack it (`xattrs-include` preserves extended file attributes, and `numeric-owner` preserves uid/gid):

```
tar xpvf stage3-amd64-20210310T214503Z.tar.xz --xattrs-include='*.*' --numeric-owner
```

Some interesting `tar` options being used here:

-   `p` preserves file permissions
-   `xattrs-include` preserve extended attributes
-   `numeric-owner` preserve uid and gid, regardless is they exist in the `/etc/passwd` of the host

## Emerge compile options

The fun bit, tuning Portage, the source based package manager Gentoo officially uses.

Some homework:

-   Read up on [GCC optimisation](https://wiki.gentoo.org/wiki/GCC_optimization) and various compiler and ISA flags you should pass to GCC, to squeeze the most out of your binaries
-   Read up on [MAKEOPTS](https://wiki.gentoo.org/wiki/MAKEOPTS)
-   Read up on Portage [FEATURES](https://wiki.gentoo.org/wiki/FEATURES) particularly `ccache`
-   Read up on [EMERGE_DEFAULT_OPTS](https://wiki.gentoo.org/wiki/EMERGE_DEFAULT_OPTS)
-   Read up on your CPU. I'm running an AMD Ryzen 5600x, the [Gentoo Ryzen wiki page](https://wiki.gentoo.org/wiki/Ryzen) and the [GCC handbook](https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html) indicates the `-march` option should be set to `znver3` or `native` for GCC to auto-detect.

When `MAKEOPTS="-jN"` is used with `EMERGE_DEFAULT_OPTS="--jobs K --load-average X.Y"` the number of possible tasks created would be up to `N*K`. Therefore, both variables need to be set with each other in mind as they create up to K jobs each with up to N tasks.

The load average value is the same as displayed by top or uptime, and for an N-core system, a load average of N.0 would be a 100% load. Another rule of thumb here is to set `X.Y=N*0.9` which will limit the load to 90%, thus maintaining responsiveness.

Given my zen 3 ryzen has 12 threads, are going with `N` of 6, `K` of 3, giving a total possible of tasks `N*K` of 18, and a load cap of `12*0.9` = `10.8` which I rounded down to `10`

-   set `N` to 6 with a `MAKEOPTS` of `-j4`
-   set `K` to 3 with a `EMERGE_DEFAULT_OPTS` of `--jobs=3`
-   set `X.Y` to 8 with a `EMERGE_DEFAULT_OPTS` `--load-average=10` and a `MAKEOPTS` of `-l10`

```
vi /mnt/gentoo/etc/portage/make.conf
```

## Mirrors

```
mirrorselect -i -o >> /mnt/gentoo/etc/portage/make.conf
```

## DNS

Create `/etc/resolv.conf` and define a `nameserver` entry.

## Bind mount pseudo-filesystems

```
mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
```

## chroot

```
chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1="(chroot) ${PS1}"
```

## Update the ebuild repository

This snapshot contains a collection of files that informs Portage about available software titles (for installation), which profiles the system administrator can select, package or profile specific news items.

```
emerge --sync
```

## The profile

A key decision point. This profile can affect defaults in _USE_, _CFLAGS_ and other system level variables. It also locks the systems to a certain subset of package versions.

The default is multilib and openrc based, so I'm good to go. Use `eselect profile set n` to change the profile.

```
eselect profile list
```

## Update the @world set

```
emerge --ask --verbose --update --deep --newuse @world
```

## Timezone

```
echo "Australia/Canberra" > /etc/timezone
emerge --config sys-libs/timezone-data
```

## Locale

```
echo "en_US ISO-8859-1" > /etc/locale.gen
echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
locale-gen
```

Now to select system wide locale setting using `eselect`:

```
eselect locale list
eselect locale set 6
```

Reload with locale and timezone preferences:

```
env-update && source /etc/profile && export PS1="(chroot) ${PS1}"
```

# Configuring a kernel

Gentoo provides a number of possible [kernel sources](https://wiki.gentoo.org/wiki/Kernel/Overview), with `sys-kernel/gentoo-sources` being a popular option.

Installing it will place the latest supported kernel sources in `/usr/src/` and symlink it to `/usr/src/linux`:

```
emerge -q sys-kernel/gentoo-sources genkernel
emerge --ask sys-apps/pciutils
```

`genkernel` can automatically make a generic kernel, however on gentoo that kind of defeats the purpose. `genkernel` is still useful when crafting a custom kernel, in particular for making an `initramfs`.

Before customising a kernel, its important to get a solid understanding of the machine your targetting; two tools useful in this endevour are `lsmod` and `lspci`. To get the later need to install `pciutils`;

```
emerge -q sys-apps/pciutils
emerge -q app-arch/lzop app-arch/lz4
lspci > ~/lspci.txt
lsmod > ~/lsmod.txt
```

## menuconfig

Time to get to work. The kernel team provides an ncurses TUI interface for going through the various options:

```
cd /usr/src/linux
make menuconfig
```

Read up on the [Gentoo Kernel Configuration Guide](https://wiki.gentoo.org/wiki/Kernel/Gentoo_Kernel_Configuration_Guide).

Topics specific to my computer:

- [Ryzen](https://wiki.gentoo.org/wiki/Ryzen#Kernel)
- [NVMe](https://wiki.gentoo.org/wiki/NVMe)

