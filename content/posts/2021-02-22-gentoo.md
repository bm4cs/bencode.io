---
layout: post
title: "Gentoo Linux"
draft: false
slug: "gentoo"
date: "2021-02-22 21:29:55"
lastmod: "2021-03-14 22:24:40"
comments: false
categories:
    - linux
tags:
    - gentoo
---

The next step in my minimalist computer journey.

Enter Gentoo, my first source based GNU/Linux distro. Pre-packaged binaries, which is the approach most other (binary based) distros take, must often cater for the lowest common denominator to ensure packages can run on lots of differing setups out in the wild. On a source based distro, I can articulate my specific needs (USE flags on Gentoo) to finely tune the binaries to my system. For example, as I plan to steer clear of software like systemd, kde and gnome, I can ensure support for these packages is NOT built into other program binaries I build for my system.

This is a big win for performance and security.

Read the [Gentoo AMD64 Handbook](https://wiki.gentoo.org/wiki/Handbook:AMD64).

Below are my notes after walking through the handbook.

<!-- vim-markdown-toc GFM -->

* [Preparation stage](#preparation-stage)
    * [Make LiveUSB key](#make-liveusb-key)
    * [Wifi](#wifi)
    * [Partition disk](#partition-disk)
    * [Format partitions](#format-partitions)
    * [Stage 3 tarball](#stage-3-tarball)
* [Installation](#installation)

<!-- vim-markdown-toc -->

# Preparation stage

## Make LiveUSB key

Download the latest iso, and use the [gentoo-usb.sh](https://wiki.gentoo.org/wiki/LiveUSB/Guide) script provided.

Boot the system.

## Wifi

Now in the running LiveUSB environment, setup temporarily configured wifi using `wpa_supplicant` like so:

```
wpa_supplicant -B -i $INTERFACE -c <(wpa_passphrase $SSID $PSK)
dhcpcd $INTERFACE
```

Don't waste time with `iw`, which doesnt support WPA/WPA2.

## Partition disk

I'm installing on my new system which is UEFI (not BIOS) based and has an NVME drive.

Aiming for 4 partitions:

-   `/dev/nvme0n1p1`: 2MiB for GRUB bootloader
-   `/dev/nvme0n1p2`: 128MiB for ESP (EFI) boot partition (FAT32)
-   `/dev/nvme0n1p3`: 18000MiB for swap
-   `/dev/nvme0n1p4`: Rest of the disk for `/`

Hence I'll be making a small FAT32 based ESP (EFI System Partition) partition, done with `set 2 boot on`.

I decided on 18MiB of swap given the system has 16GB of RAM (i.e. RAM size + 2GiB).

```
parted -a optimal /dev/nmve0n1
(parted) mklabel gpt
(parted) unit mib
(parted) mkpart primary 1 3
(parted) name 1 grub
(parted) set 1 bios_grub on
(parted) mkpart primary 3 131
(parted) name 2 boot
(parted) set 2 boot on
(parted) mkpart primary 131 18131
(parted) name 3 swap
(parted) mkpart primary 18131 -1
(parted) name 4 rootfs
```

## Format partitions

Nothing fancy here, fat32 for the ESP, and ext4 for `/`.

```
mkfs.vfat /dev/nvme0n1p2
mkfs.ext4 /dev/nvme0n1p4
mkswap /dev/nvme0n1p3
swapon /dev/nvme0n1p3
mkdir -p /mnt/gentoo
mount /dev/nvme0n1p4 /mnt/gentoo
```

## Stage 3 tarball

Using the `links` ncurses based terminal web browser, head to [https://gentoo.org/downloads/mirrors/]()

I used the aarnet mirror to download the latest openrc based multilib stage `stage3-amd64-20210310T214503Z.tar.xz` (about 200Mb)

Download the `stage3-amd64-20210310T214503Z.tar.xz.DIGESTS.xz` too.

Validate the checksum, the following should get a match:

```
grep $(sha512sum stage3-amd64-20210310T214503Z.tar.xz) stage3-amd64-20210310T214503Z.tar.xz.DIGESTS.xz --color
```

If checksum good, unpack it (`xattrs-include` preserves extended file attributes, and `numeric-owner` preserves uid/gid):

```
tar xpvf stage3-amd64-20210310T214503Z.tar.xz --xattrs-include='*.*' --numeric-owner
```

# Installation

Talk of stage 3? A stage tarball is just an archive containing a minimal environment.

> A stage 3 tarball provides an almost-complete and almost-functional system (the most important parts still missing are a kernel and a bootloader).
